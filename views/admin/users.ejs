<%- include('./partials/head') %>

<main>
    <div class="content_wrapper">
        <%- include('./partials/sideNav') %>

        <div class="main_content_wrapper">
            <div class="main_content">
                <section class="overview">
                    <div class="total_property">

                    </div>

                    <div class="total_testimony">

                    </div>
                </section>

                <!-- display all property section  -->
                <section class="table_section">
                    <table id="example" class="display" style="width:100%">
                        <thead>
                            <tr>
                                <th>Fullname</th>
                                <th>Email</th>
                                <th>Number</th>
                                <th>Country</th>
                                <th>Ip address</th>
                                <th>Last seen</th>
                                <th>Doc</th>
                            </tr>
                        </thead>
                        <tbody class="view_doc">
                            <% if(users) { %>

                                <% users.map(({_id, firstname, lastname, email, number, country, lastseen }) => { %>
                            <tr>
                                <td><%= firstname %> <%= lastname %></td>
                                <td><%= email %></td>
                                <td><%= number %></td>
                                <td><%= country %></td>
                                <td>192.168.72.5</td>
                                <td><%= lastseen %></td>
                                <td>
                                    <button class="btn view_doc_btn" data-user="<%= _id%>">View Doc</button>
                                </td>
                            </tr>
                            <% })} %>
                            

                        </tbody>
                    </table>
                </section>
            </div>
        </div>

        <!-- user document modal  -->
        <div class="docu_modal_wrapper">
            
            <div class="modal_content">
                <div class="spinner_container">
                    <image class="spinner" src="/admin/images/spinner.gif" />
                </div>
                    
            </div>
        </div>
    </div>
</main>

<script>
    const viewDocuBtn =document.querySelector('.view_doc');
    const documodalShow = document.querySelector('.docu_modal_wrapper');
    const modalContent = document.querySelector('.modal_content');

    const showUserDocumentModal = async (e) => {

        if(e.target.textContent == 'View Doc') {
            const userId = e.target.dataset.user;
            
            documodalShow.classList.add('show')
            overlay.classList.add('show');
            modalContent.classList.add('active');

            await fetchUserDocument(userId)
        }

    }
    viewDocuBtn.addEventListener('click', showUserDocumentModal);

    // close user document modal 
    const closeUserDocumentModal = (e) => {
        documodalShow.classList.remove('show');
         overlay.classList.remove('show');
    }
    
     overlay.addEventListener('click', closeUserDocumentModal);

     async function fetchUserDocument (userId){

        // make request to fetch user image 
        try {

            modalContent.innerHTML = ` 
                <div class="spinner_container">
                    <image class="spinner" src="/admin/images/spinner.gif" />
                </div>`;

            const response = await fetch(`/auth/admin/doc/${userId}`, {
                method: 'POST',
                headers: {"Content-Type": "application/json"},
            });

            if(!response.ok) {
                throw new Error('oops! something went wrong please try again')
            }

            const json = await response.json();

            if(json.error) {
                throw new Error(json.error)
            }

            if(json.success) {
                modalContent.classList.remove('active');

                console.log(json)

                let html = `
                    <div class="doc_modal_header">
                        <h2>Verify user document</h2>
                        <span class="close_user_doc"><i class="fa-solid fa-xmark"></i></span>
                    </div>
                    <div class="doc_wrapper">
                        <div class="doc">
                            <image class="doc_image" src="data:image/png;base64,${json.userDocument.doc.url}" alt="user document" />
                        </div>
                        <div class="doc_info">
                            <ul>
                                <li>Type of Id: <span>${json.userDocument.idType}</span></li>
                                <li>Issuers Country: <span>${json.userDocument.country}</span></li>
                                <li>Expiring Date: <span>${json.userDocument.date}</span></li>
                            </ul>
                        </div>
                        <div class="doc_action_container">
                            <button class="approve doc_approve" data-userid = ${json.userDocument.user}>Approve Doc</button>
                            <button class="btn reject doc_reject" data-userid = ${json.userDocument.user}>Reject Doc</button>
                        </div>
                    </div>
                `
                modalContent.innerHTML = html
                document.querySelector('.close_user_doc').addEventListener('click', closeUserDocumentModal);

            }
            
        } catch (error) {
            modalContent.innerHTML = error.message
        }
     }

     const documentVerification = async (e) => {
        if(e.target.textContent == 'Approve Doc') {
            const userId = e.target.dataset.userid
            
            try {
                const response = await fetch(`/auth/admin/approve-document/${userid}`, {
                    method: "POST",
                    headers: {"Content-Type":"application/json"},
                    body: JSON.stringify()
                })
            } catch (error) {
                
            }
            
        } else if(e.target.textContent == 'Reject Doc') {
            alert('No')
        }

     }

     modalContent.addEventListener('click', documentVerification)

</script>
    
<%- include('./partials/footer')  %>